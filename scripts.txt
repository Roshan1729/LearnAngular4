USE [CSIDW]
GO
/****** Object:  StoredProcedure [dbo].[Web_SR_UpdateSubBusinessUnits]    Script Date: 11/5/2017 1:08:30 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[Web_SR_UpdateSubBusinessUnits]
     @SubBusinessUnitID INT = NULL
	 ,@SubBusinessUnitCode INT = NULL
	 ,@SubBusinessUnitName NVARCHAR(100) = NULL
	,@EffectiveDate DATETIME
	,@ExpirationDate DATETIME = NULL
	,@CompanyName NVARCHAR(100) = NULL
	,@SubBusinessUnitManagerName NVARCHAR(100) = NULL
	,@BusinessUnitName NVARCHAR(100)=NULL
	,@UpdateUser NVARCHAR(100) = NULL
AS
SET NOCOUNT ON;

DECLARE @CompanyID INT = NULL;
DECLARE @SubBusinessUnitManagerID  INT=NULL;
DECLARE @BusinessUnitID INT=NULL;

IF (@CompanyName IS NOT NULL)
BEGIN
	SET @CompanyID = (
			SELECT TOP 1 [CompanyID]
			FROM [dbo].[Company]
			WHERE [CompanyName] = @CompanyName
			);
END

IF (@BusinessUnitName IS NOT NULL)
BEGIN
	SET @BusinessUnitID = (
			SELECT TOP 1 [BusinessUnitID]
			FROM [dbo].[BusinessUnit]
			WHERE [BusinessUnitName] = @BusinessUnitName
			);
END

IF (@SubBusinessUnitManagerName IS NOT NULL)
BEGIN
	SET @SubBusinessUnitManagerID = (
			SELECT TOP 1 SR.[SalesRepID] AS [SubBusinessUnitManagerID] FROM [SalesRep] SR
INNER JOIN [CSIDW].[dbo].[SalesRepContact] SRC ON SRC.[SalesRepID] = SR.[SalesRepID] AND SRC.[ActiveRecord] = 'A' 
 INNER JOIN [CSIDW].[dbo].[SalesRepType] SRT ON SRT.[SalesRepTypeID] = SRC.[SalesRepTypeID] AND SRT.[SalesRepTypeCode] IN ('M', 'B')

			WHERE [SalesRepFirstName]+ ' ' +[SalesRepLastName] = @SubBusinessUnitManagerName
			);
END

IF EXISTS (SELECT [SubBusinessUnitCode] FROM [CSIDW].[dbo].[SubBusinessUnit] 
WHERE LOWER([SubBusinessUnitCode]) = RTRIM(LTRIM(LOWER(@SubBusinessUnitCode))) AND [ExpirationDate] IS NULL 
AND [SubBusinessUnitID]!=@SubBusinessUnitID)
BEGIN
	SELECT 'Duplicate SubBusinessUnitCode'
END
ELSE 
BEGIN
IF EXISTS (SELECT [SubBusinessUnitName] FROM [CSIDW].[dbo].[SubBusinessUnit] 
WHERE LOWER([SubBusinessUnitName]) = RTRIM(LTRIM(LOWER(@SubBusinessUnitName))) AND [ExpirationDate] IS NULL 
AND [SubBusinessUnitID]!=@SubBusinessUnitID)
BEGIN
	SELECT 'Duplicate SubBusinessUnitName'
END
ELSE 
BEGIN 
UPDATE [CSIDW].[dbo].[SubBusinessUnit]
SET [EffectiveDate] = @EffectiveDate
	,[BusinessUnitID] = @BusinessUnitID
	,[SubBusinessUnitCode]=@SubBusinessUnitCode
	,[SubBusinessUnitName]=@SubBusinessUnitName
	,[ExpirationDate] = @ExpirationDate
	,[SubBusinessUnitManagerID] = @SubBusinessUnitManagerID
	,[CompanyID] = @CompanyID
	,[UpdateUser] = @UpdateUser
	,[UpdateDate] = GETDATE()
WHERE [SubBusinessUnitID] = @SubBusinessUnitID

	SELECT 'Success'
END
END





-------------------



USE [CSIDW]
GO
/****** Object:  StoredProcedure [dbo].[Web_SR_AddNewSubBusinessUnit]    Script Date: 11/5/2017 1:59:00 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[Web_SR_AddNewSubBusinessUnit] 
	 @SubBusinessUnitCode INT = NULL
	 ,@SubBusinessUnitName NVARCHAR(100) = NULL
	 ,@CompanyName NVARCHAR(100) = NULL
	 ,@BusinessUnitName NVARCHAR(100)=NULL
	 ,@SubSegmentName NVARCHAR(100)=NULL
	,@SubBusinessUnitManagerName NVARCHAR(100) = NULL
	,@EffectiveDate DATETIME
AS
SET NOCOUNT ON;
DECLARE @BusinessUnitID INT =NULL;
DECLARE @CompanyID INT = NULL;
DECLARE @SubBusinessUnitManagerID  NVARCHAR(100) = NULL;
DECLARE @SubBusinessUnitID INT=NULL;
DECLARE @SubSegmentID INT=NULL;
DECLARE @REffectiveDate DATETIME

IF (@CompanyName IS NOT NULL)
BEGIN
	SET @CompanyID = (
			SELECT TOP 1 [CompanyID]
			FROM [dbo].[Company]
			WHERE [CompanyName] = @CompanyName
			);

END

IF (@SubSegmentName IS NOT NULL)
BEGIN
	SET @SubSegmentID = (
			SELECT TOP 1 [SubSegmentID]
			FROM [dbo].[SubSegment]
			WHERE [SubSegmentName] = @SubSegmentName
			);
END

　
　
IF (@BusinessUnitName IS NOT NULL)
BEGIN
	SET @BusinessUnitID = (
			SELECT TOP 1 [BusinessUnitID]
			FROM [dbo].[BusinessUnit]
			WHERE [BusinessUnitName] = @BusinessUnitName
			);
END

IF (@SubBusinessUnitManagerName IS NOT NULL)
BEGIN
	SET @SubBusinessUnitManagerID = (
			SELECT TOP 1 SR.[SalesRepID] AS [SubBusinessUnitManagerID] FROM [SalesRep] SR
INNER JOIN [CSIDW].[dbo].[SalesRepContact] SRC ON SRC.[SalesRepID] = SR.[SalesRepID] AND SRC.[ActiveRecord] = 'A' 
 INNER JOIN [CSIDW].[dbo].[SalesRepType] SRT ON SRT.[SalesRepTypeID] = SRC.[SalesRepTypeID] AND SRT.[SalesRepTypeCode] IN ('M', 'B')

			WHERE [SalesRepFirstName]+ ' ' +[SalesRepLastName] = @SubBusinessUnitManagerName
			);
END

IF EXISTS (SELECT [SubBusinessUnitCode] FROM [CSIDW].[dbo].[SubBusinessUnit] 
WHERE LOWER([SubBusinessUnitCode]) = RTRIM(LTRIM(LOWER(@SubBusinessUnitCode))) AND [ExpirationDate] IS NULL
 AND [SubBusinessUnitID] != @SubBusinessUnitID )
BEGIN
	SELECT 'Duplicate SubBusinessUnitCode'
END
ELSE 
BEGIN
IF EXISTS (SELECT [SubBusinessUnitName] FROM [CSIDW].[dbo].[SubBusinessUnit] 
WHERE LOWER([SubBusinessUnitName]) = RTRIM(LTRIM(LOWER(@SubBusinessUnitName))) AND [ExpirationDate] IS NULL
 AND [SubBusinessUnitID] != @SubBusinessUnitID )
BEGIN
	SELECT 'Duplicate SubBusinessUnitName'
END
ELSE 
BEGIN 
INSERT INTO [CSIDW].[dbo].[SubBusinessUnit] (
	   [SubBusinessUnitCode]
      ,[SubBusinessUnitName]
	  ,[SubBusinessUnitManagerID]
	  ,[BusinessUnitID]
	  ,[SubSegmentID]
	  ,[CompanyID]
      ,[EffectiveDate]
	)
VALUES (
	@SubBusinessUnitCode
	,@SubBusinessUnitName
	,@SubBusinessUnitManagerID
	,@BusinessUnitID
	,@SubSegmentID
	,@CompanyID
	,@EffectiveDate
	);

	SELECT 'Success'
END
END
