USE [DEV_CRM_APPDB]
GO
/****** Object:  StoredProcedure [dbo].[AddNewReview]    Script Date: 3/20/2018 2:39:14 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[AddNewReview] @FN VARCHAR(50)
	,@LN VARCHAR(20)
	,@MailAddress NVARCHAR(100)
	,@postal NVARCHAR(255)
	,@ST VARCHAR(20)
	,@ZipCode VARCHAR(20)
	,@Telephone VARCHAR(20)
	,@Email VARCHAR(20)
	,@PF VARCHAR(50)
	,@PL VARCHAR(20)
	,@PropertyAddress NVARCHAR(100)
	,@PCity NVARCHAR(255)
	,@State VARCHAR(20)
	,@PropertyZip VARCHAR(20)
	,@Phone VARCHAR(20)
	,@EmailID VARCHAR(20)
	,@AgentFirstname VARCHAR(50)
	,@AgentLastname VARCHAR(20)
	,@AgentAddress NVARCHAR(100)
	,@AgentCity NVARCHAR(255)
	,@AgentState VARCHAR(20)
	,@AgentZip VARCHAR(20)
	,@Agentphone VARCHAR(20)
	,@AgentEmail VARCHAR(20)
	,@ProjName VARCHAR(50)
	--,@PropNumb VARCHAR(20)
	,@PropAddress NVARCHAR(100)
	,@PropCity NVARCHAR(255)
	,@PropState VARCHAR(20)
	,@PropZip VARCHAR(20)
	,@Pro VARCHAR(20)
	--,@ProjPlace VARCHAR(20)
	--,@WaterBody VARCHAR(20)
	--,@ProjCounty VARCHAR(20)
	,@Lat VARCHAR(20)
	,@Long VARCHAR(20)
	,@Desc VARCHAR(20)
	,@ActionEntity VARCHAR(20)
	,@ActionType VARCHAR(20)
AS
BEGIN
	SET NOCOUNT ON;
	
	INSERT INTO [Review].[Rev_Contact] (ORGANIZATION_NAME, REVID_YEAR)
	VALUES (@FN + ' ' + @LN, YEAR(GETDATE()))

	INSERT INTO [Review].[Rev_Contact] (PHONE,EMAIL_ADDR, REVID_YEAR)
	VALUES (@Telephone, @Email, YEAR(GETDATE()))

	INSERT INTO [Review].[CONTACT_REV_ADDR] (ADDR_LN_1, CITY, STATE, ZIP5)
	VALUES (@MailAddress, @postal, @ST, @ZipCode)

	IF (
			@PF IS NOT NULL
			OR @PL IS NOT NULL
			OR @PropertyAddress IS NOT NULL
			OR @PCity IS NOT NULL
			OR @State IS NOT NULL
			OR @PropertyZip IS NOT NULL
			OR @Phone IS NOT NULL
			OR @EmailID IS NOT NULL
			)
	BEGIN
	INSERT INTO [Review].[Rev_Contact] (ORGANIZATION_NAME, PHONE, EMAIL_ADDR, REVID_YEAR)
	VALUES (@PF + ' ' + @PL, @Phone, @EmailID, YEAR(GETDATE()))
		
	INSERT INTO [Review].[CONTACT_REV_ADDR] (ADDR_LN_1, CITY, STATE, ZIP5)
	VALUES (@PropertyAddress, @PCity, @State, @PropertyZip)
		
	END

	INSERT INTO [Review].[Rev_Contact] (ORGANIZATION_NAME,PHONE,EMAIL_ADDR )
	VALUES (@AgentFirstname + ' ' + @AgentLastname, @Agentphone, @AgentEmail)

	
	INSERT INTO [Review].[CONTACT_REV_ADDR] (ADDR_LN_1, CITY, STATE, ZIP5)
	VALUES (@AgentAddress, @AgentCity, @AgentState, @AgentZip)

		
	DECLARE @LastChangeDate as numeric(4)
	SET @LastChangeDate = (SELECT year( getdate()))

	INSERT INTO REVIEW.REVIEW (PROJECT_TITLE, --PROJECT_ADDR_LN_1,
	PROJECT_ADDR_LN_1, PROJECT_CITY,PROJECT_STATE,PROJECT_ZIP4,PROJECT_ADDR_LN_2,PROJECT_LATITUDE,
	PROJECT_LONGITUDE,PROJECT_DESCRIPTION,Action_CD,RevID_Auth_CD )
	VALUES (
		@ProjName
		--,@PropNumb
		,@PropAddress
		,@PropCity
		,@PropState
		,@PropZip
		,@Pro
		--,@ProjPlace
		--,@ProjCounty
		--,@WaterBody
		,@Lat
		,@Long
		,@Desc
		,@ActionType
		,@ActionEntity
		);

		INSERT INTO [Review].[Rev_Contact] (REVID_YEAR) Values(@LastChangeDate)

		SELECT SCOPE_IDENTITY() AS RevContactID, @LastChangeDate AS RevID_Year

END